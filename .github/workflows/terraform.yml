name: Terraform Apply and Auto Merge

on:
  workflow_run:
    workflows: ["Terraform Plan"]
    types:
      - completed

jobs:
  terraform-apply:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0 # Replace with the desired Terraform version

      - name: Set up AWS CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y awscli
          aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws configure set default.region us-east-1 # Set to your desired region
          echo "check aws cli identity"
          aws sts get-caller-identity

      - name: Download Terraform Plan Artifact
        uses: actions/download-artifact@v3
        with:
          name: terraform-plan
          path: /home/runner/work/_temp/0e04ce34-79d0-4d4e-9185-7fbacfc12ef1

      - name: Terraform Apply
        run: terraform apply -auto-approve ./downloaded-plan/plan.out
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Auto approve PR
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(jq .pull_request.number $GITHUB_EVENT_PATH)
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -d '{"event": "APPROVE"}' \
            https://api.github.com/repos/${{ github.repository }}/pulls/${PR_NUMBER}/reviews

      - name: Merge PR
        if: success()
        uses: peter-evans/merge-pull-request@v3
        with:
          pull-request: ${{ github.event.pull_request.number }}
          merge-method: merge
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
